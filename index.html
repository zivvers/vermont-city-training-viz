<!DOCTYPE html>
<meta charset="utf-8">
<style>
.bar { fill: steelblue; }


</style>
<body>
<input type="button" value="Update"/>
<div id="svg">
</div>
<script src="js/d3.v4.min.js"></script>

<script>


var margin = {top: 40, right: 20, bottom: 100, left: 60},
    width = 960 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var y = d3.scaleLinear()
          .range([height, 0]);

var parseDate = d3.timeParse("%m-%d-%y");

var formatWeekYear = d3.timeFormat("%U-%y");

var parseWeekYear = d3.timeParse("%U-%y");

var formatWeek = d3.timeFormat("%U");

var x = d3.scaleTime()
      .range([0, width]);

var yAxis = d3.axisLeft(y)
    .ticks(10);

var svg = d3.select("div#svg").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var button = d3.select("input").on("click", function() { update();});

var weeklyMileage;

var xAxis = d3.axisBottom(x);

d3.tsv("training-mileage.tsv", function(error, dat) {
  
  if (error) throw error;


  dat.forEach(function(d) {

      d.date = parseDate( d.date );
      d.mileage = +d.mileage;
      d.weekYear = formatWeekYear( d.date );
      d.weekDay = parseWeekYear(d.weekYear);
      d.midWeek = d3.timeDay.offset(d.weekDay, 3);
      d.weekNum = 'week' + d.week;

    });



    weeklyMileage = d3.nest()
      .key(function(d) { return d.weekNum; })
      .rollup( function(d) { 
                            return { 
                                mileage: d3.sum(d, function(g) { return g.mileage; })
                                , midWeek: d3.max(d, function(g) { return g.midWeek; })
                                , weekNum: d3.max(d, function(g) { return g.weekNum; })
                                //d3.max(d, function(g) { return g.weekNum; })
                              };  })
      .entries(dat)
      .map(function(d) { return { weekNum: d.key, mileage: d.value.mileage, date: d.value.midWeek }; });

    var maxWeekNum = d3.max(function(d) { return d.weekNum });

    console.log(dat);
    console.log( weeklyMileage );

    y.domain([0, d3.max(dat, function(d) { return d.mileage; })]);
    //x.domain( d3.extent(dat, function(d) { return d.date; }) );
    x.domain( [ d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), 
                                      d3.max(dat, function(d) { return d.date; }) ] )

    //console.log( dat.filter(function(d) { console.log(d3.timeFormat("%A")(d.date)); return 1==1;//d3.timeFormat("%A")(d.date) in ["Monday", "Wednesday"] 

    /* console.log( dat.filter(function(d) { return ( "Sunday" ==d3.timeFormat("%A")(d.date)) > -1 ) })
                    .map(function(d) { return d.date; }) ) ; */

    console.log( d3.timeSunday.range( d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), 
                                      d3.max(dat, function(d) { return d.date; }) ) );

    xAxis
      .tickValues( d3.timeSunday.range( d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), 
                                      d3.max(dat, function(d) { return d.date; }) ) )
                    //.map(function(d) { return d.date; }))
      //.tickFormat( function(d,i) { if (i % 2 == 0) { return d3.timeFormat('%d %b')(d);  } } )
      //.ticks(d3.timeSunday.range, 1)
      //.tickFormat( d3.timeFormat('%d %b') )
      //.tickSize( dat.filter(function(d) { return ( ["Monday", "Wednesday"].indexOf(d3.timeFormat("%A")(d.date)) > -1 ) })
        //              .map( function(d,i) { if ( i % 2 == 0 ) { return 6; } else {return 0; } }) ) ;
      //.tickFormat( d3.timeFormat('%d %b') );
      //.tickSize([6, 0, 6, 0, 10])
      ;

    console.log(  dat.filter(function(d) { return ( ["Monday", "Wednesday"].indexOf(d3.timeFormat("%A")(d.date)) > -1 ) })
                      .map( function(d,i) { if ( i % 2 == 0 ) { return 6; } else {return 0; } })  );

    svg.selectAll("rect")
      .data(dat)
      .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.date); })
      .attr("width", "10px")
      .attr("y", function(d) { return y(d.mileage); })
      .attr("height", function(d) { return height - y(d.mileage); });

      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Miles");

      //svg.selectAll("g.tick:nth-child()")

  });

function update() {

  y.domain([0, 35]);

  /*var x2 = d3.scaleBand()
      .range([0, width])
      .domain( weeklyMileage.map( function(d) { return d.weekNum; } ) );

  xAxis2 = d3.axisBottom(x2);*/

  /*var bars = svg.selectAll(".bar")
              //.data([{ date : parseDate("02-13-19"), mileage : 30 }]);
  bars
    .enter()
    .append('rect')
    .attr('width', "15px")
    .attr('height', 0)
    .attr('y', height)
    .merge(bars)
    .transition()
    .duration(1000)
    .attr("height", function(d, i) {
        return height - y(d.mileage);
    })
    .attr("y", function(d, i) {
        return y(d.mileage);
    })
    .attr("width", "15px")
    .attr("x", function(d) {
        return x(d.midWeek);  });*/
  //xAxis.tickFormat(function (d,) { if });

  console.log(weeklyMileage);

  console.log( d3.timeWednesday.ceil(d3.max(weeklyMileage, function(d) { return d.date; }) ) );

  console.log( d3.timeWednesday.range( d3.timeWednesday.floor(d3.min(weeklyMileage, function(d) { return d.date; })), 
                                      d3.timeWednesday.ceil(d3.max(weeklyMileage, function(d) { return d.date; })) ) );

  xAxis
      .tickValues( d3.timeWednesday.range( d3.timeWednesday.floor(d3.min(weeklyMileage, function(d) { return d.date; })), 
                                      d3.timeThursday.ceil(d3.max(weeklyMileage, function(d) { return d.date; })) ) )
      .tickFormat( function(d) {return "Week " + (d3.timeWednesday.count(d3.timeWednesday.floor(d3.min(weeklyMileage, function(d) { return d.date; })), d ) + 1) });

  var bars = svg.selectAll(".bar")
            .data(weeklyMileage);

  svg.selectAll(".bar")
    .enter()
    .append('rect')
    .merge( bars )
    .transition()
    .duration(1000)
    .attr("height", function(d, i) {
        return height - y(d.mileage);
    })
    .attr("y", function(d, i) {
        return y(d.mileage);
    })
    .attr("width", "10px")
    .attr("x", function(d) { console.log(x(d.date));
      return x(d.date);  }); 

  d3.selectAll("g.tick")
    .data()

  bars
      .exit()
      .transition()
      .duration(1000)
      .attr('height', 0)
      .attr('y', height)
      .remove();

  svg.select('.y.axis')
      .transition()
      .duration(1000)
      .call(yAxis);

  svg.select('.x.axis')
      .transition()
      .duration(1000)
      .call(xAxis);
/*
  d3.select(".x.axis")
    .selectAll("g.tick text")
    .transition()
    .duration(1000)
    //.delay(10000)
    .text(function(d,i) {return "week " + (i+1);}); */


}


  



</script>