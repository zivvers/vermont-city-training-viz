<!DOCTYPE html>
<meta charset="utf-8">
<style>

</style>
<body>
<div id="buttons">

	<input type="button" id="weekView" value="Weekly Agg"/>
	<input type="button" id="dayView" value="Daily Agg"/>

</div>
<div id="radio" checked="all">
	<input type="radio" id="all" value="all">All<br>
	<input type="radio" id="treadmill" value="treadmill">Treadmill<br>
	<input type="radio" id="outside" value="outside">Outside<br>
</div>

<div id="svg">
</div>
<!--script src="js/d3.v4.min.js"></script-->
<script src="https://d3js.org/d3.v4.min.js"></script>
<!--script src="js/d3-queue.v3.min.js"></script-->

<script>

d3.select("#radio")
	.select("#all")
	.property("checked", true);

d3.select("#radio")
	.selectAll("input")
	.on("click", function() { //console.log("cliked radio");
							  radioClick(d3.select(this)); })


var margin = {top: 40, right: 20, bottom: 100, left: 100},
    width = 960 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var y = d3.scaleLinear()
          .range([height, 0]);

var parseDate = d3.timeParse("%m-%d-%Y");

var formatWeekYear = d3.timeFormat("%U-%y");

var formatDate = d3.timeFormat("%m-%d-%Y");

var parseWeekYear = d3.timeParse("%U-%y");

var formatWeek = d3.timeFormat("%U");

var stack = d3.stack();

var x = d3.scaleTime()
      .range([0, width]);

// for our stacked aggregated graph
var z = d3.scaleOrdinal(d3.schemeCategory10).domain(["treadmill", "outside"])//.range(["#FF0000", "#009933"])

var yAxis = d3.axisLeft(y)
    .ticks(10);

var svg = d3.select("div#svg").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

d3.select("input#weekView").on("click", function() { weekView();});

d3.select("input#dayView").on("click", function() { dayView();});

var weeklyMileage;

var xAxis = d3.axisBottom(x);

var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


var maxMileMap = {};

var dat;

var totMileage;

d3.csv("training-mileage.csv", function(error, data) {
  
  if (error) throw error;

  var midWeekPrev = parseDate("01-01-1990"); //dummy date

  dat = data;

  dat.forEach(function(d,i) {

      d.date = parseDate( d.date );
      d.mileage = +d.mileage;
      d.weekYear = formatWeekYear( d.date );
      d.weekDay = parseWeekYear(d.weekYear);
      d.treadmillInd = +d.treadmill;
      d.insideOrOut = +d.treadmill ? "treadmill" : "outside";
      d.midWeek = d3.timeDay.offset(d.weekDay, 3);
      d.midWeekPrevInd = midWeekPrev.valueOf() == d.midWeek.valueOf() ? 0 : 1;
      midWeekPrev = d.midWeek;

      if (! maxMileMap[d.midWeek]) {

        maxMileMap[d.midWeek] = [d.mileage, d.date];

      } else if (maxMileMap[d.midWeek][0] < d.mileage) {

        console.log("comparing miles");

        maxMileMap[d.midWeek] = [d.mileage, d.date];

      }

    });


  	totMileage = d3.nest()
  					.key(function(d) { return d.weekDay; })
  					//.key(function(d) { return d.insideOrOut; })
      //.key(function(d) { return d.treadmillInd; })
      				.entries(dat)
      				.map(function(d) { console.log(d);
      									var tempArr = [];
      									d.values.forEach(function(h, i) {
	      									tempArr.push({
	      										weekDay : h.weekDay ,
	      										date : h.date ,
	      										midWeek : h.midWeek ,
	      										insideOrOut : h.insideOrOut ,
	      										outside : h.insideOrOut == 'outside' ? h.mileage : 0 ,
	      										treadmill : h.insideOrOut == 'treadmill' ? h.mileage : 0 });			
      									});

      									return tempArr;
      				} ) ;

    //console.log( totMileage );


    weeklyMileage = d3.nest()
      .key(function(d) { return d.weekDay; })
      .key(function(d) { return d.treadmillInd; })
      .rollup( function(d) { 
                            return { 
                                mileage: d3.sum(d, function(g) { return g.mileage }),
                                date: d3.min(d, function(d) { return d.weekDay; }) };  })
      .entries(dat)
      .map(function(d) { return { date : d.values[0].value.date 
                                  , treadmill:  d.values.filter(function(d) { return d.key == 1; })[0] ? d.values.filter(function(d) { return d.key == 1; })[0].value.mileage : 0
                                  , outside:  d.values.filter(function(d) { return d.key == 0; })[0] ? d.values.filter(function(d) { return d.key == 0; })[0].value.mileage : 0 }}) ;

    //console.log( weeklyMileage );

    y.domain([0, d3.max(dat, function(d) { return d.mileage; })]);

    x.domain( [ d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), d3.max(dat, function(d) { return d.date; }) ] ).nice();


    console.log( d3.timeSunday.range( d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), 
                                      d3.max(dat, function(d) { return d.date; }) ) );

    xAxis
      .tickValues( d3.timeSunday.range( d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), 
                                      d3.max(dat, function(d) { return d.date; }) ) )
      ;

    console.log(  dat.filter(function(d) { return ( ["Monday", "Wednesday"].indexOf(d3.timeFormat("%A")(d.date)) > -1 ) })
                      .map( function(d,i) { if ( i % 2 == 0 ) { return 6; } else {return 0; } })  );

 
    // notice nested data structure
    g.selectAll("g.week")
      .data(totMileage)
      .enter().append("g")
        .attr("class", "week") 
        .attr("week", function(d,i) { return i; })
      .selectAll("g")
      .data(function(d) { 	console.log( stack.keys(["outside", "treadmill"])(d) );
      						return stack.keys(["outside", "treadmill"])(d); })
      .enter().append("g")
      .attr("class", "type")
      .attr("id", function(d) { return d.key; } )
      .style("fill", function(d) { return z(d.key); })
      .selectAll("rect")
      .data(function(d) { return d; })
        .enter().append("rect")
        .attr("x", function(d) { return x(d.data.date); })
        .attr("y", function(d) { return y(d[1]); })
        .attr("height", function(d) { return y(d[0]) - y(d[1]); })
        //.style("fill", function(d) { return z(d.data.insideOrOut); })
        .attr("width", 5);


	g.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + height + ")")
	    .call( xAxis )
	  .selectAll("text")
	    .attr("dy", ".35em")
	    .attr("transform", "rotate(45)")
	    .attr("x", 4)
	    .style("text-anchor", "start");

    g.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("class", "label")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Miles");


  });

function radioClick(clickedElem) {

	//console.log(clickedElem.attr("value"));
	//console.log(d3.select("#radio").select('input:checked').attr("value"));
	//if click the already checked button, don't do anything
	/*if (clickedElem.attr("value") == d3.select("#radio").select('input:checked').attr("value") ) {

		console.log("NOTHING TO DO IN THIS TOWN");

	} else {

		d3.select("#radio").selectAll('input').property("checked", false);
		var filterTo = clickedElem.attr("value");
		clickedElem.property("checked", true);

	}*/

	d3.select("#radio").selectAll('input').property("checked", false);
	clickedElem.property("checked", true);

	// have to change stuff to respond!
	if (d3.select("#radio").attr("checked") != clickedElem.attr("value")) {

		d3.select("#radio").attr( "checked", clickedElem.attr("value") );


		// removeBarTransitionWeek(clickedElem.attr("value"), 

	}


}






// change view back to original day view
function dayView() {

    //y.domain([0, d3.max(dat, function(d) { return d.mileage; })]);

    x.domain( [ d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), d3.max(dat, function(d) { return d.date; }) ] ).nice();

    xAxis
      .tickValues( d3.timeSunday.range( d3.timeSunday.floor(d3.min(dat, function(d) { return d.date; })), 
                                      d3.max(dat, function(d) { return d.date; }) ) );


    g.select("g#treadmill")
      .selectAll("rect")
      .transition()
      .duration(1000)
      .attr("height", function(d) { return 0; })
      .attr("y", function(d,i) { /*console.log(d);*/ return y(d[0]); })
      
      .on("end", function(d,i) { d3.select(this).remove();
      							 console.log(i);
      							 if (i == (weeklyMileage.length-1)) {

      							 	    /* g.select("g#outside")
									    	.selectAll("rect.weekAgg")
									    	.transition()
									    	.duration(1000)
									    	.attr("y", y(0))
									    	.attr("height", 0)
									    	.on("end", function(d,i) {
									    		d3.select(this).remove();

									    		if (i == (weeklyMileage.length-1)) { */

									    			createDailyBars();

									    		//}

									    	//});

      							 } }) ; 
      ;

    y.domain([0, d3.max(dat, function(d) { return d.mileage; })]);

    //g.select("g#treadmill")
    //  .selectAll("rect")
    //  .remove();

    var bars = svg.select("g#outside").selectAll("rect");
 
    /*
		DELAY

    g.select("g#outside")
      .data(stack.keys(["mileage"])(dat))
      .enter().append("g")
        .merge(gSer)
        .attr("class", "ser")
    .selectAll("rect.dayAgg")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("class", "dayAgg")
      .style("fill", "purple")
      .attr("class", "test")
      .attr("x", function(d) { return x( d.data.weekDay ); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", 5)
      .transition()
      .duration(1000)
      .attr("x", function(d) { return x(d.data.date); });


	svg.select('.y.axis')
	    .transition()
	    .duration(1000)
	    .call(yAxis);
							*/
	svg.select('.x.axis')
      .transition()
      .duration(1000)
      .call(xAxis);



}

/* a function to remove either the treadmill or the outdoors when it is week aggregated */
function removeBarTransitionWeek( filterOut /*'treadmill' or 'outside'*/, currAgg /* day or week */) {

	var keep = filterOut == 'treadmill' ? 'outside' : 'treadmill';
	var gBars;
	if (currAgg == 'day') {

		gBars = d3.select("g#outside");

	} else {

		if (filterOut == 'treadmill') {

			gBars = d3.select("g#outside");

		} else {

			gBars = d3.select("g#treadmill");

		}

	} 


    gBars
      .selectAll("rect")
      .transition()
      .duration(1000)	
      .attr("y", function(d) { return y(d[1]); } )
      .attr("height", function(d) { return y(d[1]); } )
      .on("end", function() { d3.select(this).remove(); })


}




// change view to week aggregated
function weekView() {

  y.domain([0, d3.max(weeklyMileage, function(d) { return d.outside + d.treadmill; })]);

  console.log('week transition');
  /*xAxis
      .tickValues( d3.timeWednesday.range( d3.min(weeklyMileage, function(d) { return d.date; }), 
                                      d3.timeThursday.ceil(d3.max(weeklyMileage, function(d) { return d.date; })) ) )

      .tickFormat( function(d) { return "Week " + (d3.timeWednesday.count(d3.timeWednesday.floor(d3.min(weeklyMileage, function(d) { return d.date; })), d ) + 1) })
      ; */

  var bars = svg.selectAll("g.type").selectAll("rect");

  /* move bars to wednesday position of each week */
  bars
    .transition()
    .duration( 1000 )
    .attr("x", function(d) { return x(d.data.weekDay) })
    //.style("fill",  z("outside") )
    ;

  bars
      .filter(function(d) { //console.log(d.data.midWeek);
      						return d.data.date.valueOf() != maxMileMap[d.data.midWeek][1].valueOf(); })
      .transition()
      .delay(1000)
      .remove()
      .on("end", function() { console.log('# rects: '+( 2*d3.selectAll("g.type rect").size() ) );

      						if ( d3.selectAll("g.type rect").size() == 2*weeklyMileage.length) {
                              
                              console.log("removal complete");
                              
                              transBars();
                            } }) ; 

  svg.select('.y.axis')
      .transition()
      .duration(1000)
      .call(yAxis);

  svg.select(".x.axis")
    .selectAll("g.tick")
    .select("text")
    .transition()
    .duration(1000)
    .text( function(d,i) { return "Week " + (i+1); } ) ;
    //.attr("transform", function(i) { return "translate(" })

  /* old way of axis transition...would re-rotate labels :-( */
  /*svg.select('.x.axis')
    .selectAll("text")
    .style("fill", "none");

  svg.select('.x.axis')
      .transition()
      .duration(900)
      .call(xAxis)
    .selectAll("text")
      .attr("x", 4)
      .attr("dy", ".35em")
      .attr("transform", "rotate(45)")
      .style("text-anchor", "start") 
      ;
  svg.select('.x.axis')
      .selectAll("text")
      .transition()
      .delay(1000)
      .duration(100)
      .style("fill", "black"); */

}

function transBars() {

  var gType = svg.select("g.type")//.selectAll("rect");
    , bars = gType.selectAll("g.type rect");

  var weekG = g.selectAll("g.week")
    //.data( stack.keys( ["outside","treadmill"] )(weeklyMileage) )
    .data( weeklyMileage )
    .enter().append("g")
    .merge( d3.selectAll("g.week") );

  weekG.selectAll("g.type")
      .data( function(d) { return stack.keys( ["outside","treadmill"] )([d]); } )
      .enter().append("g")
      .merge( d3.selectAll("g.type") )
      .attr("class", "type")
      .attr( "id", function(d) { return d.key; } ) 
      //.style("fill", function(d) { return z(d.key); })
      ;

  console.log('here');
  g.selectAll("g#outside") 
  	.select("rect")
  	//.data(function(d) { return d; })
  	//.enter().append("rect")
  	//.merge(bars)
  	.transition()
    .duration(1000)
    .attr("x", function(d) { return x(d[0].data.date); })
    .attr("y", function(d) { return y(d[0][1]); })
    .attr("height", function(d) { return y(d[0][0]) - y(d[0][1]); })
    //.style("fill", function(d) { console.log(d.key); return z(d.key); })
    ;
 
  g.selectAll("g#treadmill")
      .select("rect")
      .attr("x", function(d) { return x(d[0].data.date); })
      .attr("y", function(d) { return y(d[0][0]); })
      .attr("height", 0) 
      .transition()
      .delay(1000)
      .duration(1000)
      .attr("y", function(d) { return y(d[0][1]); })
      .attr("height", function(d) { return y(d[0][0]) - y(d[0][1]); }) 
      //.attr("fill", function(d) { console.log(d.key); return z(d.key); });
      ;
	
}
 

function createDailyBars() {

    var gSer = svg.select(".ser") ;
    		//bars = gSer.selectAll("rect");

	bars = g.selectAll("rect");

    g.select("g#outside")
      .selectAll("g.weekG")
      .data(totMileage)
      .enter().append("g")
      .merge(d3.selectAll("g.weekG"))
      .selectAll("rect")
	  .data(function(d) { return d.values; })

    	.enter().append("rect")
    	.attr("y", function(d) { return y(d.mileage); })
    	.attr("x", function(d) { return x( d.weekDay ); })
    	.attr("height", function(d) { return y(0)-y(d.mileage); })
    	.merge(bars)
    	.attr("class", "update")
    	//.style("fill", z("outside"))
    	.attr("y", function(d) { return y(d.mileage); })
    	.attr("x", function(d) { return x( d.weekDay ); })
    	.attr("height", function(d) { return y(0)-y(d.mileage); })
    	.attr("width", 5)
    	;

	g.select("g#outside")
		.selectAll("rect")
        .transition()
    	.duration(1000)
    	.attr("x", function(d) { return x( d.date ); })
    	//.style("fill", function(d) { return z(d.insideOrOut); })
    	;



//    bars.exit().remove();

	/*d3.selectAll("rect").transition()
    	.duration(1000)
    	.attr("x", function(d) { return x( d.data.date ); }); */


     /*bars.enter().append("rect")
      .style("fill", "purple")
      .attr("x", function(d) { return x( d.data.weekDay ); })
      .attr("y", function(d) { return y(d[0]) })
      .attr('width', 5)
      .attr("height", function(d) { return y(d[0]) - y(d[1]); }); */

   // bars.exit().remove(); 


      //.attr("class", "NEWW_20");
      
      //.attr("height", function(d) { return 0;/*y(d[0]) - y(d[1]);*/ })
    /*  .attr("width", 5)
      .transition()
      .duration(1000)
      .attr("x", function(d) { return x(d.data.date); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); });
	*/

	svg.select('.y.axis')
	    .transition()
	    .duration(1000)
	    .call(yAxis);
						
	svg.select('.x.axis')
      .transition()
      .duration(1000)
      .call(xAxis);


}


    
 


  



</script>